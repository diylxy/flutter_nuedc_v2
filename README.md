# 基于单目视觉的目标物测量装置

**2025全国大学生电子设计竞赛 C题国一 安卓版移植**

（大三上专业课较多，这里先给出使用方法，更多开发及编译细节正在逐步完善。大家也可以参考Github Actions的指令，Clone后编译项目。）

## 使用方法

### 一些注意事项

受Dart下camera库的限制，需要将照片临时存储到App缓存目录下。在重新打开App时会自动清空缓存。你也可以手动在设置中清空App缓存。

App内的功能均不会影响App以外的部分，如果标定失败导致图像扭曲，在App内的设置中恢复出厂设置即可，可以放心尝试各种功能。

### 相机选择

软件启动时，受打开速度影响，有些手机可能不会自动启动相机，需要在设置->相机选择中选择对应摄像头。

### 棋盘格标定
在测量前，首先需要使用棋盘格图像标定手机摄像头的焦距和畸变。方法是：
使用电脑打开下面这个PDF（或者用A4纸打印出来放在平整表面上）：

[checker_210x297_9x7_20.pdf](tools/checker_210x297_9x7_20.pdf)

确保全部棋盘格的**角点**显示在屏幕上，然后用尺子量出相邻两个角点间在显示屏/A4纸上，在App中点击“设置”->棋盘格间距，拖动滑动条设置棋盘格间距为测得的间距。

然后将摄像头对准棋盘格图像，在 **不同位置、不同距离（棋盘格占取景框面积不小于10%且不大于80%、不同角度（倾角建议45度以内，不然可能识别不到）** 点击“拍摄”按钮拍摄棋盘格，建议拍摄张数`40~60张`，多了可能会拖慢计算速度。

拍摄完记得点计算，程序将自动计算出相机标定信息，在弹出“标定成功”提示后，拉到页面最底下点保存标定结果。

然后回到主页，找一个目标物（在电脑上打开[目标物_多个正方形v9.docx](tools/目标物_多个正方形v9.docx)，进入打印预览，缩放到露出四个边角，或者打印出来）

点击“一键测量”，检查右侧摄像头窗口图像有没有明显畸变，如果有，说明上一步标定拍摄张数少了，或者没有在多个角度、距离拍摄，导致相机畸变计算错误。

注意：OpenCV中的findChessboardCorners是检测棋盘格角点的，7\*9的棋盘格有6\*8个角点，因此在`constants.dart`中有：

```dart
const (int, int) chessboardSize = (6, 8);
```

至于为啥不用文本框，因为作品没有键盘，里面数字输入全用的滑动条，直接CV了一个过去。

### 阈值调节
在原作品中检测目标物采用的是Canny边缘检测再找轮廓，但在移植过程中，我发现转黑白后找轮廓效果更好，因此改用了这一方案。调节黑白阈值的方法如下：

在设置页，打开“黑白调参模式”，右侧将实时显示相机预览中经过黑白阈值计算的图像，调节“边缘阈值”滑动条，直到能区分出目标物的边缘，之后调节“测量阈值”等于边缘阈值即可。

修改阈值后，记得点“保存标定结果”，否则下次打开App将恢复上次保存时的设置。

其中：

`边缘阈值`：用于检测黑色矩形边框

`测量阈值`：在多正方形检测任务中，在找到可能的正方形后，向对角线方向偏移20像素，检查这个点是否小于`测量阈值`，即为黑色，如果四个角点处有任意一处大于，认为这个区域不是正方形。

目前程序中没用到Canny阈值。